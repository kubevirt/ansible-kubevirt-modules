---
- name: Deploy a VMI with cloud-init data
  hosts: localhost
  connection: local
  tasks:
    - name: Create test-fedora-vmi-ps VMI
      k8s:
       state: present
       name: test-fedora-vmi-ps
       namespace: default
       inline:
         apiVersion: kubevirt.io/v1alpha2
         kind: VirtualMachineInstance
         metadata:
           name: test-fedora-vmi-ps
           namespace: default
           labels:
             kubevirt.io/vmPreset: vmi-small
         spec:
           domain:
             devices:
               disks:
               - disk:
                   bus: virtio
                 name: registrydisk
                 volumeName: registryvolume
               - cdrom:
                   bus: virtio
                 name: cloudinitdisk
                 volumeName: cloudinitvolume
           volumes:
           - name: registryvolume
             registryDisk:
               image: kubevirt/fedora-cloud-registry-disk-demo:latest
           - name: cloudinitvolume
             cloudInitNoCloud:
               userData: |
                 #cloud-config
                 hostname: test-fedora-vmi-ps
                 users:
                   - name: kubevirt
                     gecos: KubeVirt Project
                     sudo: ALL=(ALL) NOPASSWD:ALL
                     passwd: $6$/hOv3djtWA7DJ3Tz$PufE5F29KS6mlI1lWHbD1WTQBHhrtIYdyNbWMKP0PbsY/YsRSn1sPEQSvYbPjXor3uqcYdAJY0XPx2JtJ6hBC1
                     shell: /bin/bash
                     home: /home/kubevirt
                     lock_passwd: false
                     ssh_authorized_keys:
                         - "{{ lookup('file', '../test_rsa.pub') }}"
