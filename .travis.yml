sudo: required
dist: xenial

language: python
python:
  - "2.7"
env:
  - KUBECONFIG=tests/k8s/config

branches:
  only:
  - master
  - "/^v[0-9]/"
install:
  - sudo pip install -U pyasn1 pyopenssl
  - sudo pip install openshift --ignore-installed PyYAML
  - sudo pip install -r requirements-dev.txt
jobs:
  include:
    - stage: Tests
      name: "Default (minikube with latest k8s)"

cache:
  directories:
  - cache
  - "~/.minikube/cache"
addons:
  apt:
    sources:
    - sourceline: 'ppa:ansible/ansible'
    packages:
    - ansible
before_script:
## FIXME Workaround for https://github.com/kubernetes/kubernetes/issues/61058
### And https://github.com/LiliC/travis-minikube/blob/e0f26f7b388057f51a0e2558afd5f990e07b6c49/.travis.yml#L11
- sudo mount --make-rshared /

- bash -x ci/prepare-host $CPLATFORM
- bash -x ci/prepare-host virtctl
- bash -x ci/start-cluster $CPLATFORM $CVER
- bash -x ci/deploy-kubevirt $CPLATFORM

script:
- pytest --cov=lib tests
- flake8 --version
- flake8 lib/ansible/modules
- timeout 8m bash -x test.sh
