---
- name: VM Creation with DataVolumes
  hosts: localhost
  connection: local
  module_defaults:
    group/k8s:
      namespace: default
  tasks:
    - name: Check for known open issues
      include_tasks: known_issues.yaml
      vars:
        current_playbook: dv_vm

    - name: Create a fedora VM from a DataVolume
      kubevirt_vm:
        state: running
        wait: true
        wait_timeout: 200
        name: fedora-dv-test
        labels:
          special: test-e2e-key
        memory: 2Gi
        cpu_cores: 1
        datavolumes:
          - name: fedora-dv-test
            source:
              http:
                url: "https://dl.fedoraproject.org/pub/fedora/linux/releases/31/Cloud/x86_64/images/Fedora-Cloud-Base-31-1.9.x86_64.qcow2"
            pvc:
              storageClassName: "{{ storage_provisioner }}"
              accessModes:
                - ReadWriteOnce
              storage: 5Gi
      register: result
      failed_when: result.changed != true or not result.method in ('create', 'apply')

    - name: Remove the VM recently created
      kubevirt_vm:
        state: absent
        name: fedora-dv-test
