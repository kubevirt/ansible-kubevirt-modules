---
- name: Create a PVC from local VM image
  hosts: localhost
  connection: local
  vars:
    pvc_name: test-upload-pvc
  tasks:
    - name: Create a PVC annotated for upload
      kubevirt_pvc:
       namespace: default
       name: "{{ pvc_name }}"
       access_modes:
       - ReadWriteOnce
       size: 100Mi
       cdi_source:
         upload: yes
       wait: yes

    - name: Get the CDI upload host endpoint
      k8s_facts:
        kind: Route
        namespace: cdi
        name: cdi-uploadproxy-route
      register: route_cdi

    - name: set facts for upload_host
      set_fact:
        upload_host: "{{ 'https://' + route_cdi.resources[0].spec['host'] }}"
    
    - name: Get the cirros file
      get_url:
        url: https://download.cirros-cloud.net/0.4.0/cirros-0.4.0-x86_64-disk.img
        dest: /tmp/cirros-0.4.0-x86_64-disk.img

    - name: Upload local image to pvc
      kubevirt_cdi_upload:
        pvc_namespace: default
        pvc_name: "{{ pvc_name }}"
        upload_host: "{{ upload_host }}"
        upload_host_verify_ssl: false
        path: /tmp/cirros-0.4.0-x86_64-disk.img

